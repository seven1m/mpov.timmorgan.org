---
layout: post
title: Use a Proc with ActiveRecords' default_scope Method
tags: []
status: publish
type: post
published: true
meta: {}
---
<p>Today, my <a href="http://github.com/rails/rails/commit/b1b26af9a2f1c2037f7c2167d747ed33cc639763" target="_blank">small patch</a> to Rails was applied by the core team. This is only my second contribution to Rails, so I'm fairly stoked about it being accepted.</p><div><p /><div>This will allow you to pass a block to the default_scope method in ActiveRecord. It doesn't sound like much, but opens up some wonderful possibilities.</div></div><p /><div>First, a review of what default_scope does:</div><p /><div><p><a href="https://gist.github.com/635165">https://gist.github.com/635165</a></p></div><p /><div>The first call to Person.all applies the default scope and adds a where clause that returns only non-deleted folks.</div><p /><div>The next two calls are passed through the unscoped { } block so that the default scope isn't applied.</div><p /><div>Great! Using default_scope keeps me from having to specify a common condition over and over again on every (or nearly every) query.</div><p /><div>What else can we use this for?</div><p /><div>Well, let's say you have an app with different customers. Each customer needs to have the illusion of operating in their own "database" while your server has just one.</div><p /><div>Each customer has their own subdomain, say <a href="http://foo.example.com" target="_blank">foo.example.com</a> or <a href="http://bar.example.com" target="_blank">bar.example.com</a>. Depending on the hostname, let's scope our queries to that particular customer.</div><p /><div><p><a href="https://gist.github.com/635169">https://gist.github.com/635169</a></p></div><p /><div>Oops! This doesn't work because the call to where() is made at the time the class is created. Instead, we need the where() to be called each time a query is made.</div><p /><div>With named_scope, you can pass a lambda/proc, but with default_scope, you cannot. Until now that is!</div><p /><div>With my wonderful, 6-line patch (plus tests of course), you can now pass a proc to default_scope:</div><p /><div><p><a href="https://gist.github.com/635207">https://gist.github.com/635207</a></p></div><p /><div>This technique is exactly what my project <a href="http://github.com/seven1m/onebody" target="_blank">OneBody</a> uses to scope customer "sites" to their specific site_id based on hostname. The Person.current_site_id bit is actually called inside the ApplicationController once the hostname is determined.</div><p /><p /><div>It won't change the world, but being able to contribute this small bit of code back to the framework I love and use everyday feels great.</div>
