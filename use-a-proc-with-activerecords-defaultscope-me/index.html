<!doctype html><html lang=en-us><head><title>Use a Proc with ActiveRecords' default_scope Method | My Point of View</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Today, my small patch to Rails was applied by the core team. This is only my second contribution to Rails, so I&rsquo;m fairly stoked about it being accepted.
This will allow you to pass a block to the default_scope method in ActiveRecord. It doesn&rsquo;t sound like much, but opens up some wonderful possibilities.
First, a review of what default_scope does:
The first call to Person.all applies the default scope and adds a where clause that returns only non-deleted folks."><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon></head><body><nav class=navigation><a href=/><span class=arrow>←</span>Home</a>
<a href=/tags>Tags</a>
<a href=/about>About</a></nav><main class=main><section id=single><h1 class=title>Use a Proc with ActiveRecords' default_scope Method</h1><div class=tip><time datetime="2010-10-19 00:00:00 +0000 UTC">Oct 19, 2010</time>
<span class=split>·</span>
<span>312 words</span>
<span class=split>·</span>
<span>2 minute read</span></div><div class=content><p>Today, my <a href=http://github.com/rails/rails/commit/b1b26af9a2f1c2037f7c2167d747ed33cc639763 target=_blank rel=noopener>small patch</a> to Rails was applied by the core team. This is only my second contribution to Rails, so I&rsquo;m fairly stoked about it being accepted.</p><p>This will allow you to pass a block to the <code>default_scope</code> method in ActiveRecord. It doesn&rsquo;t sound like much, but opens up some wonderful possibilities.</p><p>First, a review of what <code>default_scope</code> does:</p><script type=application/javascript src=https://gist.github.com/seven1m/635165.js></script><p>The first call to <code>Person.all</code> applies the default scope and adds a where clause that returns only non-deleted folks.</p><p>The next two calls are passed through the unscoped { } block so that the default scope isn&rsquo;t applied.</p><p>Great! Using <code>default_scope</code> keeps me from having to specify a common condition over and over again on every (or nearly every) query.</p><p>What else can we use this for?</p><p>Well, let&rsquo;s say you have an app with different customers. Each customer needs to have the illusion of operating in their own &ldquo;database&rdquo; while your server has just one.</p><p>Each customer has their own subdomain, say foo.example.com or bar.example.com. Depending on the hostname, let&rsquo;s scope our queries to that particular customer.</p><script type=application/javascript src=https://gist.github.com/seven1m/635169.js></script><p>Oops! This doesn&rsquo;t work because the call to <code>where()</code> is made at the time the class is created. Instead, we need the <code>where()</code> to be called each time a query is made.</p><p>With <code>named_scope</code><sup>1</sup>, you can pass a lambda/proc, but with <code>default_scope</code>, you cannot. Until now that is!</p><p>With my wonderful, 6-line patch (plus tests of course), you can now pass a proc to <code>default_scope</code>:</p><script type=application/javascript src=https://gist.github.com/seven1m/635207.js></script><p>This technique is exactly what my project <a href=http://github.com/seven1m/onebody target=_blank rel=noopener>OneBody</a> uses to scope customer &ldquo;sites&rdquo; to their specific <code>site_id</code> based on hostname. The <code>Person.current_site_id</code> bit is actually called inside the ApplicationController once the hostname is determined.</p><p>It won&rsquo;t change the world, but being able to contribute this small bit of code back to the framework I love and use everyday feels great.</p><p>Footnotes:</p><ol><li><code>named_scope</code> is just <code>scope</code> as of Rails 3.</li></ol></div></section></main><footer id=footer><div class=copyright>© Copyright
2022
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span></div><div class=powerby>Powered by <a href=http://www.gohugo.io/>Hugo</a> Theme By <a href=https://github.com/nodejh/hugo-theme-mini>nodejh</a></div></footer></body></html>